# ICMP Authentication & Template Refactor Summary (March 2025)

This document summarizes the key changes made to the authentication flow and template handling within the ICMP backend and frontend.

## 1. Authentication Flow Changes

The authentication mechanism was refactored to improve security and clarity, moving away from using the global master `ICMP_API_KEY` for regular frontend operations.

**Previous Flow:**
- Frontend required `ICMP_API_KEY`, `userId`, `businessId`, `businessApiKey`.
- `/api/save-config` validated all four, set cookies for both `icmpApiKey` and `businessApiKey`.
- Backend routes used `@require_api_key` which primarily checked the `icmpApiKey` cookie or `Authorization: Bearer <ICMP_API_KEY>` header.

**Revised Flow:**
1.  **`ICMP_API_KEY` (Master Key):**
    *   Lives **only** on the backend server (loaded from environment variables via `backend/config.py`).
    *   **NOT** used by the standard frontend flow.
    *   Protected backend routes (using the original `@require_api_key` decorator in `backend/auth.py`) require this key, typically passed via `Authorization: Bearer <ICMP_API_KEY>` header for administrative or server-to-server tasks (e.g., creating templates via `backend/routes/template_management.py`, potentially initial business creation via `POST /businesses`).
2.  **`businessApiKey` (Per-Business Key):**
    *   Generated by the backend (`backend/routes/businesses.py`) during business creation (`POST /businesses`) and returned in the response.
    *   User enters this key, `userId`, and `businessId` into the frontend Configuration (`front-end/src/components/Configuration.js`).
    *   Frontend calls `/api/save-config` (in `backend/app.py`) sending only `userId`, `businessId`, `businessApiKey`.
    *   Backend validates these three against the database (`users` and `businesses` tables).
    *   If valid, backend sets a secure, `HttpOnly` cookie named `businessApiKey`.
3.  **Ongoing Business Operations:**
    *   Browser automatically sends the `businessApiKey` cookie with subsequent requests.
    *   Backend routes operating on specific business data (e.g., stages, messages) are protected by the **new** `@require_business_api_key` decorator (`backend/auth.py`).
    *   This decorator extracts `business_id` (from URL param or request body), reads the `businessApiKey` from the cookie, and verifies against the `businesses` table that the key is valid *for that specific business_id*.

## 2. Template Handling Changes

A distinction was made between regular templates used by stages and default templates used as starting points.

1.  **Template Types and Storage:**
    *   All templates are stored in the `templates` table (replacing the deprecated `prompt_templates` table).
    *   Templates are distinguished by their `template_type` field:
        * Regular types (e.g., "stage_selection", "data_extraction", "response_generation") are used directly by stages.
        * Default types (e.g., "default_stage_selection", "default_data_extraction", "default_response_generation") serve as starting points for creating or updating templates.
    *   Both regular and default templates are managed via routes in `backend/routes/template_management.py`.
    *   Template management routes are protected by the global `@require_api_key` decorator.

2.  **Stage-Template Relationship:**
    *   Stages no longer contain embedded template text or configuration.
    *   Instead, the `stages` table has foreign key references to templates:
        * `stage_selection_template_id`
        * `data_extraction_template_id`
        * `response_generation_template_id`
    *   These IDs link to templates in the `templates` table with corresponding regular types.
    *   The stages can be created with empty templates initially, and the templates can be populated later by:
        * Manually entering content
        * Copying content from default templates
        * Modifying existing templates

3.  **Template Usage in Message Handling:**
    *   The message handling logic (`backend/routes/message_handling.py`) fetches template IDs from the relevant stage.
    *   It then queries the `templates` table to retrieve the actual template content.
    *   The templates are rendered with context data and sent to OpenAI for processing.

## 3. Key Files Modified

*   `backend/routes/businesses.py`:
    *   Added `businessApiKey` generation and return value to `create_business`.
    *   Applied `@require_business_api_key` to `get_business`.
*   `front-end/src/components/Configuration.js`:
    *   Removed `ICMP API Key` input field and related state/logic.
    *   Updated `handleSave` fetch call to `/api/save-config` (removed `Authorization` header and `apiKey` from body).
*   `backend/app.py`:
    *   Modified `/api/save-config` to remove validation and cookie setting for `icmpApiKey`. Only validates `userId`, `businessId`, `businessApiKey` and sets `businessApiKey` cookie.
*   `backend/auth.py`:
    *   Added new `@require_business_api_key` decorator for business-level authentication.
*   `backend/routes/stages.py`:
    *   Applied `@require_business_api_key` to `create_stage`.
    *   Modified `create_stage` to accept template ID references instead of embedded configurations.
*   `backend/schemas/stages.json`:
    *   Replaced JSONB configuration fields with template ID references.
    *   Updated `required` fields to include template ID fields.
*   `backend/routes/template_management.py`:
    *   Updated to manage both regular and default templates in the `templates` table.
    *   Kept `@require_api_key` decorator.
*   `backend/routes/message_handling.py`:
    *   Applied `@require_business_api_key` to `/message` route.
    *   Updated logic to fetch template IDs from stages and then retrieve templates from the `templates` table.
*   `backend/routes/conversations.py`:
    *   Applied `@require_business_api_key` to `get_conversations`. Added comment about needed authorization enhancement.

## 4. Outstanding Items / Next Steps

*   **Database Schema:** Ensure `stages` table has correct template ID foreign key columns (`stage_selection_template_id`, `data_extraction_template_id`, `response_generation_template_id`) and the `templates` table has the necessary fields, including `template_type`.
*   **User Authentication:** Implement a proper user login system (e.g., email/password, sessions/JWT).
*   **Authorization:** Implement finer-grained checks (beyond business key authentication) to ensure the logged-in user has permission to access specific resources (e.g., user X can only get conversations for businesses they belong to).
*   **Stage Selection Logic:** Implement the actual logic in `message_handling.py` to determine the correct stage based on conversation history/intent.
*   **Template Management UI:** Develop frontend components for:
    *   Creating and editing templates
    *   Applying default templates to regular templates
    *   Viewing and selecting templates by type
*   **Testing:** Update frontend tests (e.g., `Configuration.test.js`) and add backend tests for the new auth and template logic.
*   **Cookie Security:** Ensure `secure=True` is set for the `businessApiKey` cookie in production (HTTPS). 