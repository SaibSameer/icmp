<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICMP Message Processing Debugger</title>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --error-color: #dc3545;
            --success-color: #28a745;
            --border-color: #ddd;
            --bg-light: #f5f5f5;
            --text-color: #333;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6; 
            padding: 0;
            margin: 0;
            display: flex;
            background-color: var(--bg-light);
            color: var(--text-color);
        }

        .main-content {
            flex: 1;
            max-width: 1200px;
            padding: 20px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            min-height: 100vh;
        }

        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 500;
            color: var(--text-color);
        }

        input[type="text"], 
        input[type="password"], 
        textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        textarea { 
            height: 120px; 
            resize: vertical;
            font-family: inherit;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
            margin-right: 10px;
        }

        button:hover { 
            background-color: var(--primary-hover);
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        #responseArea {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            background-color: white;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
        }

        .error { 
            color: var(--error-color);
            border-color: var(--error-color);
            background-color: #fff5f5;
        }

        .success {
            color: var(--success-color);
            border-color: var(--success-color);
            background-color: #f0fff4;
        }

        h1 {
            color: var(--text-color);
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        h2 {
            color: var(--text-color);
            margin-top: 30px;
            font-size: 1.5em;
        }
        
        h3 {
            color: var(--text-color);
            margin-top: 25px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-divider {
            margin: 30px 0;
            border: none;
            border-top: 1px solid var(--border-color);
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .process-step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white;
        }
        
        .step-header {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .step-content {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .prompt-box, .response-box {
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .prompt-box {
            background-color: #f0f8ff;
            border: 1px solid #b8daff;
        }
        
        .response-box {
            background-color: #f0fff4;
            border: 1px solid #c3e6cb;
        }
        
        .system-prompt {
            font-style: italic;
            color: #6c757d;
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
        }
        
        .text-muted {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .logged-in {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .logged-out {
            color: var(--error-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .process-log {
            margin-top: 20px;
        }
        
        .no-logs {
            color: #6c757d;
            font-style: italic;
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .log-list {
            list-style-type: none;
            padding: 0;
        }
        
        .log-item {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .log-item:hover {
            background-color: #f0f8ff;
        }
        
        /* New styles for flow diagram */
        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 30px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            overflow-x: auto;
        }
        
        .stage-node {
            padding: 15px;
            background-color: white;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            text-align: center;
            min-width: 150px;
            position: relative;
        }
        
        .stage-node.active {
            background-color: #e6f7ff;
            border-color: #0056b3;
            box-shadow: 0 0 10px rgba(0,123,255,0.3);
        }
        
        .stage-node.completed {
            background-color: #f0fff4;
            border-color: #28a745;
        }
        
        .arrow {
            font-size: 24px;
            color: var(--primary-color);
            margin: 0 10px;
        }
        
        /* New styles for variable substitution */
        .variable-substitution {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .original-template, .context-data, .substituted-template {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white;
        }
        
        .variable-highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        /* New styles for API inspector */
        .api-inspector {
            margin: 20px 0;
        }
        
        .request-details, .response-details {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white;
            margin-bottom: 15px;
            overflow-x: auto;
        }
        
        .api-inspector pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
        }
        
        /* New styles for performance metrics */
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white;
            text-align: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .main-content {
                padding: 10px;
            }
            
            .process-step {
                margin: 10px 0;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .variable-substitution {
                grid-template-columns: 1fr;
            }
            
            .performance-metrics {
                grid-template-columns: 1fr;
            }
            
            .flow-diagram {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stage-node {
                margin-bottom: 10px;
            }
            
            .arrow {
                transform: rotate(90deg);
                margin: 5px 0;
            }
        }

        .debug-window {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .debug-controls {
            margin-bottom: 10px;
        }

        .debug-controls button {
            margin-right: 10px;
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .debug-controls button:hover {
            background-color: #0056b3;
        }

        .debug-content {
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
            background-color: #fff;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .debug-section {
            margin-bottom: 15px;
        }

        .debug-section h3 {
            margin-top: 0;
            margin-bottom: 5px;
            color: #495057;
        }

        .debug-section pre {
            margin: 0;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .call-details {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .call-details h4 {
            margin: 10px 0 5px 0;
            color: #495057;
            font-size: 0.9em;
        }

        .call-details pre {
            margin: 5px 0 15px 0;
            padding: 8px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .metadata-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .metadata-label {
            font-weight: bold;
            color: #495057;
        }

        .metadata-value {
            color: #007bff;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 1200px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px 0;
        }

        .debug-section {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .call-details {
            margin: 10px 0;
            padding: 15px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .call-details h4 {
            margin: 10px 0 5px 0;
            color: #495057;
            font-size: 0.9em;
        }

        .call-details pre {
            margin: 5px 0 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
        }

        .metadata-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 8px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .metadata-label {
            font-weight: bold;
            color: #495057;
        }

        .metadata-value {
            color: #007bff;
        }

        /* Responsive styles for modal */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 10px auto;
                padding: 15px;
            }

            .call-details pre {
                max-height: 200px;
            }
        }

        .show-details {
            margin-top: 10px;
            padding: 5px 10px;
            font-size: 12px;
            background-color: #6c757d;
        }

        .show-details:hover {
            background-color: #5a6268;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .status-info {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #0050b3;
        }
        
        .status-success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        
        .status-error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: #f5222d;
        }
    </style>
</head>
<body>
    <div class="main-content">
        <h1>ICMP Message Processing Debugger</h1>
        
        <!-- Login Section -->
        <h2>Login</h2>
        <div class="login-section">
            <div class="form-group">
                <label for="businessId">Business ID</label>
                <input id="businessId" type="text" placeholder="Enter Business ID">
            </div>
            
            <div class="form-group">
                <label for="ownerId">Owner ID</label>
                <input id="ownerId" type="text" placeholder="Enter Owner ID">
                <button onclick="lookupOwner()">Look Up Owner</button>
                <button onclick="createOwner()">Create New Owner</button>
            </div>
            
            <div class="form-group">
                <label for="apiKey">API Key</label>
                <input id="apiKey" type="password" placeholder="Enter API Key">
            </div>
            
            <div class="form-group">
                <label for="businessName">Business Name</label>
                <input id="businessName" type="text" placeholder="Enter Business Name">
            </div>
            
            <div class="button-group">
                <button id="loginButton" onclick="login()">Login</button>
                <button id="createBusinessButton" onclick="createBusiness()">Create Business</button>
                <span id="loginStatus" class="logged-out">Not logged in</span>
            </div>
        </div>
        
        <hr class="section-divider">
        
        <!-- Message Sending Section -->
        <h2>Send Message</h2>
        <div class="message-section">
            <div class="form-group">
                <label for="userId">Message Sender ID (User)</label>
                <input id="userId" type="text" placeholder="Enter User ID or generate new">
                <button onclick="document.getElementById('userId').value = generateUUID()">Generate New</button>
                <button onclick="createUser()">Create User</button>
            </div>
            
            <div class="form-group">
                <label for="conversationId">Conversation ID (Optional)</label>
                <input id="conversationId" type="text" placeholder="Enter Conversation ID or leave empty for new conversation">
            </div>
            
            <div class="form-group">
                <label for="messageContent">Message Content</label>
                <textarea id="messageContent" placeholder="Enter your message"></textarea>
            </div>
            
            <div class="button-group">
                <button id="sendButton" onclick="sendMessage()">Send Message</button>
            </div>
            
            <div id="responseArea">
                <div class="text-muted">Send a message to see the response</div>
            </div>
            <!-- New section to display stages -->
            <div id="stagesArea" style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: white;">
                <h4>Available Stages</h4>
                <div id="stagesList" class="text-muted">No stages available yet</div>
            </div>
        </div>
        
        <hr class="section-divider">
        
        <!-- Flow Diagram Section (New) -->
        <h2>Message Processing Flow</h2>
        <div class="flow-diagram">
            <div class="stage-node" id="stage-selection-node">Stage Selection</div>
            <div class="arrow">→</div>
            <div class="stage-node" id="data-extraction-node">Data Extraction</div>
            <div class="arrow">→</div>
            <div class="stage-node" id="response-generation-node">Response Generation</div>
        </div>
        
        <hr class="section-divider">
        
        <!-- Template Variables Test Section -->
        <h2>Template Variables Test</h2>
        <div class="template-variables-section">
            <div class="form-group">
                <label for="templateContent">Template Content</label>
                <textarea id="templateContent" placeholder="Enter template with variables (e.g. Hello {{user_name}}, welcome to {{business_name}}!)"></textarea>
            </div>
            
            <div class="form-group">
                <label for="testVariables">Test Variables (JSON)</label>
                <textarea id="testVariables" placeholder='{"user_name": "John", "business_name": "Test Business"}'></textarea>
            </div>
            
            <div class="button-group">
                <button id="testTemplateButton" onclick="testTemplate()">Test Template</button>
            </div>
            
            <div id="templateTestResult" class="response-box">
                <div class="text-muted">Test result will appear here</div>
            </div>
        </div>
        
        <hr class="section-divider">
        
        <!-- Processing Details Section -->
        <h2>Processing Details</h2>
        <div id="processLogArea" class="process-log">
            <div class="no-logs">No processing data available yet</div>
        </div>
        
        <!-- LLM Calls Debug Section -->
        <h2>LLM Calls Debug</h2>
        <div class="debug-controls">
            <button onclick="showLLMDebug()" id="showLLMDebug">Show LLM Calls</button>
            <button onclick="clearLLMDebug()" id="clearLLMDebug">Clear Debug</button>
        </div>

        <!-- Modal Window for LLM Debug -->
        <div id="llmDebugModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>LLM Calls Debug</h2>
                    <span class="close" onclick="closeLLMDebug()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="debug-section">
                        <h3>Stage Selection Call</h3>
                        <div class="call-details">
                            <h4>Input</h4>
                            <pre id="stageSelectionInput"></pre>
                            <h4>System Prompt</h4>
                            <pre id="stageSelectionSystemPrompt"></pre>
                            <h4>Response</h4>
                            <pre id="stageSelectionResponse"></pre>
                            <h4>Metadata</h4>
                            <pre id="stageSelectionMetadata"></pre>
                        </div>
                    </div>
                    <div class="debug-section">
                        <h3>Data Extraction Call</h3>
                        <div class="call-details">
                            <h4>Input</h4>
                            <pre id="dataExtractionInput"></pre>
                            <h4>System Prompt</h4>
                            <pre id="dataExtractionSystemPrompt"></pre>
                            <h4>Response</h4>
                            <pre id="dataExtractionResponse"></pre>
                            <h4>Metadata</h4>
                            <pre id="dataExtractionMetadata"></pre>
                        </div>
                    </div>
                    <div class="debug-section">
                        <h3>Response Generation Call</h3>
                        <div class="call-details">
                            <h4>Input</h4>
                            <pre id="responseGenerationInput"></pre>
                            <h4>System Prompt</h4>
                            <pre id="responseGenerationSystemPrompt"></pre>
                            <h4>Response</h4>
                            <pre id="responseGenerationResponse"></pre>
                            <h4>Metadata</h4>
                            <pre id="responseGenerationMetadata"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Variable Substitution Section (New) -->
        <h2>Variable Substitution</h2>
        <div id="variableSubstitutionArea" class="variable-substitution">
            <div class="original-template">
                <h4>Original Template</h4>
                <pre id="originalTemplate">No template data available</pre>
            </div>
            <div class="context-data">
                <h4>Context Data</h4>
                <pre id="contextData">No context data available</pre>
            </div>
            <div class="substituted-template">
                <h4>Substituted Template</h4>
                <pre id="substitutedTemplate">No substituted template available</pre>
            </div>
        </div>
        
        <!-- Performance Metrics Section (New) -->
        <h2>Performance Metrics</h2>
        <div id="performanceMetricsArea" class="performance-metrics">
            <div class="metric">
                <div class="metric-label">Total Processing Time</div>
                <div class="metric-value" id="totalProcessingTime">-</div>
                <div class="metric-unit">milliseconds</div>
            </div>
            <div class="metric">
                <div class="metric-label">Token Usage</div>
                <div class="metric-value" id="tokenUsage">-</div>
                <div class="metric-unit">tokens</div>
            </div>
            <div class="metric">
                <div class="metric-label">Estimated Cost</div>
                <div class="metric-value" id="estimatedCost">-</div>
                <div class="metric-unit">USD</div>
            </div>
        </div>
        
        <!-- API Inspector Section (New) -->
        <h2>API Inspector</h2>
        <div id="apiInspectorArea" class="api-inspector">
            <div class="request-details">
                <h4>Request</h4>
                <pre id="apiRequest">No request data available</pre>
            </div>
            <div class="response-details">
                <h4>Response</h4>
                <pre id="apiResponse">No response data available</pre>
            </div>
            <div class="button-group">
                <button id="resendButton" onclick="resendRequest()" disabled>Resend Request</button>
            </div>
        </div>
        
        <hr class="section-divider">
        
        <!-- Recent Logs Section -->
        <h2>Recent Process Logs</h2>
         <div class="form-group">
             <label for="logsBusinessId">Business ID for Logs</label>
             <input id="logsBusinessId" type="text" placeholder="Enter Business ID to fetch logs for">
        </div>
        <div class="button-group">
            <button onclick="fetchRecentLogs()">Refresh Logs</button>
        </div>
        <div id="recentLogsArea">
            <div class="no-logs">No recent logs available</div>
        </div>
        
        <hr class="section-divider">
        
        <!-- Status Section -->
        <h2>Status</h2>
        <div id="statusArea">
            <div id="networkStatus" class="text-muted">No network activity yet</div>
        </div>
        
        <div class="process-steps">
            <div class="process-step">
                <div class="step-header">Stage 1: Intent Detection</div>
                <div class="step-content">
                    <div class="prompt-box" id="stageSelectionInput"></div>
                    <div class="response-box" id="stageSelectionResponse"></div>
                    <button onclick="showLLMDebug('Stage Selection')" class="show-details">Show Details</button>
                </div>
            </div>
            
            <div class="process-step">
                <div class="step-header">Stage 2: Data Extraction</div>
                <div class="step-content">
                    <div class="prompt-box" id="dataExtractionInput"></div>
                    <div class="response-box" id="dataExtractionResponse"></div>
                    <button onclick="showLLMDebug('Data Extraction')" class="show-details">Show Details</button>
                </div>
            </div>
            
            <div class="process-step">
                <div class="step-header">Stage 3: Response Generation</div>
                <div class="step-content">
                    <div class="prompt-box" id="responseGenerationInput"></div>
                    <div class="response-box" id="responseGenerationResponse"></div>
                    <button onclick="showLLMDebug('Response Generation')" class="show-details">Show Details</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration for local development
        const API_BASE_URL = 'http://127.0.0.1:5000';
        const MASTER_API_KEY = 'cd0fd3314e8f1fe7cef737db4ac21778ccc7d5a97bbb33d9af17612e337231d6';
        
        // State management
        let isLoggedIn = false;
        
        // Initialize the app
        function init() {
            // Pre-fill the business ID, owner ID, and API key
            document.getElementById('businessId').value = 'bc7e1824-49b4-4056-aabe-b045a1f79e3b';
            document.getElementById('ownerId').value = '4c38fa55-ff8c-421a-878f-c09ecdb78c7b';
            document.getElementById('apiKey').value = 'cd0fd3314e8f1fe7cef737db4ac21778ccc7d5a97bbb33d9af17612e337231d6';
            
            // Check if we're already logged in
            const savedApiKey = localStorage.getItem('businessApiKey');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
                
                const savedBusinessId = localStorage.getItem('businessId');
                if (savedBusinessId) {
                    document.getElementById('businessId').value = savedBusinessId;
                    isLoggedIn = true;
                    document.getElementById('loginStatus').textContent = 'Logged in';
                    document.getElementById('loginStatus').className = 'logged-in';
                }
            }
            
            // Generate a UUID for user_id if not already set
            if (!document.getElementById('userId').value) {
                document.getElementById('userId').value = generateUUID();
            }
        }
        
        // Call init when the page loads
        window.addEventListener('DOMContentLoaded', init);
        
        // Utility function to generate a UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // Show success message
        function showSuccess(message) {
            const responseArea = document.getElementById('responseArea');
            responseArea.textContent = message;
            responseArea.classList.remove('error');
            responseArea.classList.add('success');
            
            // Also update status
            updateStatus(message, 'success');
        }
        
        // Show error message
        function showError(message) {
            const responseArea = document.getElementById('responseArea');
            responseArea.textContent = message;
            responseArea.classList.remove('success');
            responseArea.classList.add('error');
            
            // Also update status
            updateStatus('ERROR: ' + message, 'error');
        }
        
        // Update status display
        function updateStatus(message, type = 'info') {
            const statusElem = document.getElementById('networkStatus');
            statusElem.textContent = message;
            
            // Remove all status classes
            statusElem.classList.remove('status-info', 'status-success', 'status-error');
            
            // Add appropriate status class
            statusElem.classList.add('status', `status-${type}`);
            
            // Clear status after 5 seconds if it's not an error
            if (type !== 'error') {
                setTimeout(() => {
                    if (statusElem.textContent === message) {
                        statusElem.textContent = 'No network activity';
                        statusElem.classList.remove('status-info', 'status-success', 'status-error');
                        statusElem.classList.add('status');
                    }
                }, 5000);
            }
        }
        
        // Login function
        async function login() {
            const businessId = document.getElementById('businessId').value.trim();
            const ownerId = document.getElementById('ownerId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!businessId || !ownerId || !apiKey) {
                showError('Business ID, Owner ID, and API Key are required to login');
                return;
            }
            
            updateStatus('Verifying owner...', 'info');
            
            // Prepare login data for POST body
            const loginData = {
                userId: ownerId,
                businessId: businessId,
                businessApiKey: apiKey
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/verify-owner`, {
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify(loginData),
                    mode: 'cors',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) { 
                    throw new Error(data.error || 'Owner verification failed');
                }
                
                // Store credentials if verification succeeds
                localStorage.setItem('businessApiKey', apiKey);
                localStorage.setItem('businessId', businessId);
                localStorage.setItem('ownerId', ownerId);
                
                isLoggedIn = true;
                showSuccess('Login successful! Owner verification confirmed.');
                document.getElementById('loginStatus').textContent = 'Logged in as Owner';
                document.getElementById('loginStatus').className = 'logged-in';
                document.getElementById('loginButton').textContent = 'Logged In';
                document.getElementById('loginButton').disabled = true;

            } catch (error) {
                console.error('Login error:', error);
                isLoggedIn = false;
                showError(`Login failed: ${error.message}`);
                document.getElementById('loginStatus').textContent = 'Not logged in';
                document.getElementById('loginStatus').className = 'logged-out';
                localStorage.removeItem('businessApiKey');
                localStorage.removeItem('businessId');
                localStorage.removeItem('ownerId');
                document.getElementById('loginButton').textContent = 'Login';
                document.getElementById('loginButton').disabled = false;
            }
        }
        
        // Function to show LLM debug modal
        function showLLMDebug(stepType = null) {
            const modal = document.getElementById('llmDebugModal');
            modal.style.display = 'block';

            // If a specific step type is provided, scroll to that section
            if (stepType) {
                const sections = document.querySelectorAll('.debug-section h3');
                for (const section of sections) {
                    if (section.textContent.toLowerCase().includes(stepType.toLowerCase())) {
                        section.scrollIntoView({ behavior: 'smooth' });
                        break;
                    }
                }
            }
        }

        // Function to close LLM debug modal
        function closeLLMDebug() {
            const modal = document.getElementById('llmDebugModal');
            modal.style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('llmDebugModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Function to update LLM debug information
        function updateLLMDebug(data) {
            if (!data.processing_steps) return;

            // Process each step
            data.processing_steps.forEach(step => {
                let stepPrefix;
                switch(step.step) {
                    case 'intent_detection':
                        stepPrefix = 'stageSelection';
                        break;
                    case 'data_extraction':
                        stepPrefix = 'dataExtraction';
                        break;
                    case 'response_generation':
                        stepPrefix = 'responseGeneration';
                        break;
                    default:
                        return;
                }

                const inputId = `${stepPrefix}Input`;
                const systemPromptId = `${stepPrefix}SystemPrompt`;
                const responseId = `${stepPrefix}Response`;
                const metadataId = `${stepPrefix}Metadata`;

                // Update input
                if (document.getElementById(inputId)) {
                    document.getElementById(inputId).textContent = step.prompt || 'No input available';
                }

                // Update system prompt
                if (document.getElementById(systemPromptId)) {
                    document.getElementById(systemPromptId).textContent = step.system_prompt || 'No system prompt available';
                }

                // Update response
                if (document.getElementById(responseId)) {
                    document.getElementById(responseId).textContent = step.response || 'No response available';
                }

                // Update metadata
                if (document.getElementById(metadataId)) {
                    const metadata = {
                        'Template ID': step.template_id || 'N/A',
                        'Template Name': step.template_name || 'N/A',
                        'Timestamp': step.timestamp || 'N/A'
                    };

                    let metadataHtml = '';
                    for (const [key, value] of Object.entries(metadata)) {
                        metadataHtml += `
                            <div class="metadata-item">
                                <span class="metadata-label">${key}:</span>
                                <span class="metadata-value">${value}</span>
                            </div>
                        `;
                    }
                    document.getElementById(metadataId).innerHTML = metadataHtml;
                }
            });

            // Show the modal if there's data
            showLLMDebug();
        }

        // Function to clear LLM debug
        function clearLLMDebug() {
            const elements = [
                'stageSelectionInput', 'stageSelectionSystemPrompt', 'stageSelectionResponse', 'stageSelectionMetadata',
                'dataExtractionInput', 'dataExtractionSystemPrompt', 'dataExtractionResponse', 'dataExtractionMetadata',
                'responseGenerationInput', 'responseGenerationSystemPrompt', 'responseGenerationResponse', 'responseGenerationMetadata'
            ];

            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = 'No data available';
                }
            });
        }

        // Send message function
        async function sendMessage() {
            if (!isLoggedIn) {
                showError('You must login first before sending messages');
                return;
            }
            
            const businessId = document.getElementById('businessId').value.trim();
            const userId = document.getElementById('userId').value.trim();
            const conversationId = document.getElementById('conversationId').value.trim() || null;
            const apiKey = document.getElementById('apiKey').value.trim();
            const message = document.getElementById('messageContent').value.trim();
            
            if (!businessId || !userId || !apiKey || !message) {
                showError('Business ID, User ID, API Key, and message content are required');
                return;
            }
            
            // Prepare message data
            const messageData = {
                message: message,
                business_id: businessId,
                user_id: userId,
                conversation_id: conversationId
            };
            
            updateStatus('Sending message...', 'info');
            document.getElementById('sendButton').disabled = true;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'businessapikey': apiKey
                    },
                    body: JSON.stringify(messageData),
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Server responded with status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update response area with formatted JSON
                const responseArea = document.getElementById('responseArea');
                responseArea.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                responseArea.classList.remove('error');
                
                // Save the conversationId if one was returned and none was provided
                if (data.conversation_id && !conversationId) {
                    document.getElementById('conversationId').value = data.conversation_id;
                }
                
                // Update processing details
                updateProcessingDetails(data);
                
                // Update LLM debug information
                updateLLMDebug(data);
                
                // Update performance metrics
                updatePerformanceMetrics(data);
                
                // Update variable substitution
                updateVariableSubstitution(data);
                
                // Update API inspector
                updateApiInspector(messageData, data);
                
                // Update stages display
                updateStagesDisplay(data);
                
                updateStatus('Message sent successfully!', 'success');
            } catch (error) {
                console.error('Send message error:', error);
                showError(`Failed to send message: ${error.message}`);
            } finally {
                document.getElementById('sendButton').disabled = false;
            }
        }

        // Function to update processing details
        function updateProcessingDetails(data) {
            const processLogArea = document.getElementById('processLogArea');
            if (!data.processing_steps) return;

            let logHtml = '<div class="log-list">';
            data.processing_steps.forEach(step => {
                logHtml += `
                    <div class="log-item">
                        <div class="step-header">${step.step}</div>
                        <div class="step-content">
                            <div class="prompt-box">${step.prompt || 'No prompt available'}</div>
                            <div class="response-box">${step.response || 'No response available'}</div>
                        </div>
                    </div>
                `;
            });
            logHtml += '</div>';
            processLogArea.innerHTML = logHtml;
        }

        // Function to update performance metrics
        function updatePerformanceMetrics(data) {
            if (!data.metrics) return;

            const metrics = data.metrics;
            document.getElementById('totalProcessingTime').textContent = metrics.total_processing_time || '-';
            document.getElementById('tokenUsage').textContent = metrics.token_usage || '-';
            document.getElementById('estimatedCost').textContent = metrics.estimated_cost || '-';
        }

        // Function to update variable substitution
        function updateVariableSubstitution(data) {
            if (!data.template_data) return;

            const templateData = data.template_data;
            document.getElementById('originalTemplate').textContent = templateData.original_template || 'No template available';
            document.getElementById('contextData').textContent = JSON.stringify(templateData.context_data || {}, null, 2);
            document.getElementById('substitutedTemplate').textContent = templateData.substituted_template || 'No substituted template available';
        }

        // Function to update API inspector
        function updateApiInspector(requestData, responseData) {
            document.getElementById('apiRequest').textContent = JSON.stringify(requestData, null, 2);
            document.getElementById('apiResponse').textContent = JSON.stringify(responseData, null, 2);
        }

        // Function to update stages display
        function updateStagesDisplay(data) {
            const stagesList = document.getElementById('stagesList');
            if (data.agent_stages && Array.isArray(data.agent_stages) && data.agent_stages.length > 0) {
                let stagesHtml = '<ul>';
                data.agent_stages.forEach(stage => {
                    stagesHtml += `<li>${stage.stage_name} (${stage.stage_id})</li>`;
                });
                stagesHtml += '</ul>';
                stagesList.innerHTML = stagesHtml;
            } else {
                stagesList.textContent = 'No stages available';
            }
        }

        // Function to resend request
        async function resendRequest() {
            const requestData = JSON.parse(document.getElementById('apiRequest').textContent);
            await sendMessage();
        }

        // Look up owner ID function
        async function lookupOwner() {
            const businessId = document.getElementById('businessId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!businessId || !apiKey) {
                showError('Business ID and API Key are required to look up owner');
                return;
            }
            
            // Prepare lookup data
            const lookupData = {
                businessId: businessId,
                businessApiKey: apiKey
            };
            
            updateStatus('Looking up owner...', 'info');
            
            try {
                const url = `${API_BASE_URL}/api/lookup-owner`;
                console.log('Looking up owner with URL:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(lookupData),
                    credentials: 'include',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        throw new Error(`Lookup failed! status: ${response.status}, message: ${errorData.error || 'Unknown error'}`);
                    } else {
                        const text = await response.text();
                        throw new Error(`Lookup failed! status: ${response.status}, message: ${text || 'Unknown error'}`);
                    }
                }
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('ownerId').value = data.owner_id;
                    showSuccess(`Owner ID found: ${data.owner_id}`);
                } else {
                    throw new Error(data.error || 'Failed to find owner ID');
                }
                
            } catch (error) {
                console.error('Lookup error:', error);
                showError(`Failed to look up owner ID: ${error.message}`);
            }
        }

        // Create business function
        async function createBusiness() {
            const ownerId = document.getElementById('ownerId').value.trim();
            const businessName = document.getElementById('businessName').value.trim();
            
            if (!ownerId || !businessName) {
                showError('Owner ID and Business Name are required to create a business');
                return;
            }
            
            updateStatus('Creating business...', 'info');
            document.getElementById('createBusinessButton').disabled = true;
            
            try {
                const response = await fetch(`${API_BASE_URL}/businesses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${MASTER_API_KEY}`
                    },
                    body: JSON.stringify({
                        owner_id: ownerId,
                        business_information: {
                            business_name: businessName
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Server responded with status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update the business ID field with the new ID
                document.getElementById('businessId').value = data.business_id;
                
                // Update the API key field with the new key
                document.getElementById('apiKey').value = data.api_key;
                
                showSuccess(`Business created successfully! Business ID: ${data.business_id}`);
                updateStatus('Business created successfully!', 'success');
            } catch (error) {
                console.error('Create business error:', error);
                showError(`Failed to create business: ${error.message}`);
            } finally {
                document.getElementById('createBusinessButton').disabled = false;
            }
        }

        // Create owner function
        async function createOwner() {
            updateStatus('Creating owner...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/create-owner`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${MASTER_API_KEY}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Server responded with status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update the owner ID field with the new ID
                document.getElementById('ownerId').value = data.owner_id;
                
                showSuccess(`Owner created successfully! Owner ID: ${data.owner_id}`);
                updateStatus('Owner created successfully!', 'success');
            } catch (error) {
                console.error('Create owner error:', error);
                showError(`Failed to create owner: ${error.message}`);
            }
        }

        // Create user function
        async function createUser() {
            const userId = document.getElementById('userId').value.trim();
            
            if (!userId) {
                showError('User ID is required');
                return;
            }
            
            updateStatus('User will be created automatically when sending first message', 'info');
            showSuccess(`User ID ${userId} will be created automatically when sending first message`);
        }

        // Test template function
        async function testTemplate() {
            if (!isLoggedIn) {
                showError('You must login first before testing templates');
                return;
            }
            
            const templateContent = document.getElementById('templateContent').value.trim();
            const testVariables = document.getElementById('testVariables').value.trim();
            const businessId = document.getElementById('businessId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!templateContent) {
                showError('Template content is required');
                return;
            }
            
            let variables = {};
            try {
                if (testVariables) {
                    variables = JSON.parse(testVariables);
                }
            } catch (e) {
                showError('Invalid JSON in test variables');
                return;
            }
            
            updateStatus('Testing template...', 'info');
            document.getElementById('testTemplateButton').disabled = true;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/templates/test-template`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${MASTER_API_KEY}`,
                        'businessapikey': apiKey
                    },
                    body: JSON.stringify({
                        template: templateContent,
                        variables: variables,
                        business_id: businessId
                    }),
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Server responded with status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update template test result
                const resultArea = document.getElementById('templateTestResult');
                resultArea.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                resultArea.classList.remove('error');
                
                updateStatus('Template test completed successfully!', 'success');
            } catch (error) {
                console.error('Template test error:', error);
                const resultArea = document.getElementById('templateTestResult');
                resultArea.textContent = `Error: ${error.message}`;
                resultArea.classList.add('error');
                updateStatus('Template test failed!', 'error');
            } finally {
                document.getElementById('testTemplateButton').disabled = false;
            }
        }
    </script>
</body>
</html>
