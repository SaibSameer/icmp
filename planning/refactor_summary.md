# ICMP Authentication & Template Refactor Summary

This document summarizes the key changes made to the authentication flow and template handling within the ICMP backend and frontend.

## 1. Authentication Flow Changes

The authentication mechanism was refactored to improve security and clarity, moving away from using the global master `ICMP_API_KEY` for regular frontend operations.

### Previous Flow
- Frontend required `ICMP_API_KEY`, `userId`, `businessId`, `businessApiKey`
- `/api/save-config` validated all four, set cookies for both `icmpApiKey` and `businessApiKey`
- Backend routes used `@require_api_key` which primarily checked the `icmpApiKey` cookie or `Authorization: Bearer <ICMP_API_KEY>` header

### Revised Flow
1.  **`ICMP_API_KEY` (Master Key):**
    *   Lives **only** on the backend server (loaded from environment variables via `backend/config.py`)
    *   **NOT** used by the standard frontend flow
    *   Protected backend routes (using the original `@require_api_key` decorator in `backend/auth.py`) require this key, typically passed via `Authorization: Bearer <ICMP_API_KEY>` header for administrative or server-to-server tasks

2.  **`businessApiKey` (Per-Business Key):**
    *   Generated by the backend during business creation (`POST /businesses`) and returned in the response
    *   User enters this key, `userId`, and `businessId` into the frontend Configuration
    *   Frontend calls `/api/save-config` sending only `userId`, `businessId`, `businessApiKey`
    *   Backend validates these three against the database
    *   If valid, backend sets a secure, `HttpOnly` cookie named `businessApiKey`

3.  **Ongoing Business Operations:**
    *   Browser automatically sends the `businessApiKey` cookie with subsequent requests
    *   Backend routes operating on specific business data are protected by the `@require_business_api_key` decorator
    *   This decorator verifies the key is valid for the specific business_id

## 2. Template Handling Changes

A distinction was made between regular templates used by stages and default templates used as starting points.

### Template Types and Storage
*   All templates are stored in the `templates` table
*   Templates are distinguished by their `template_type` field:
    * Regular types (e.g., "stage_selection", "data_extraction", "response_generation")
    * Default types (e.g., "default_stage_selection", "default_data_extraction", "default_response_generation")
*   Both regular and default templates are managed via routes in `backend/routes/template_management.py`
*   Template management routes are protected by the global `@require_api_key` decorator

### Stage-Template Relationship
*   Stages no longer contain embedded template text or configuration
*   The `stages` table has foreign key references to templates:
    * `stage_selection_template_id`
    * `data_extraction_template_id`
    * `response_generation_template_id`
*   These IDs link to templates in the `templates` table with corresponding regular types
*   Templates can be populated by:
    * Manually entering content
    * Copying content from default templates
    * Modifying existing templates

### Template Usage in Message Handling
*   Message handling logic fetches template IDs from the relevant stage
*   Queries the `templates` table to retrieve the actual template content
*   Templates are rendered with context data and sent to OpenAI for processing

## 3. Key Files Modified

### Backend Changes
*   `backend/routes/businesses.py`:
    *   Added `businessApiKey` generation
    *   Applied `@require_business_api_key` to `get_business`
*   `backend/app.py`:
    *   Modified `/api/save-config` for new auth flow
*   `backend/auth.py`:
    *   Added new `@require_business_api_key` decorator
*   `backend/routes/stages.py`:
    *   Updated for template ID references
*   `backend/schemas/stages.json`:
    *   Updated schema for template references
*   `backend/routes/template_management.py`:
    *   Updated for new template system
*   `backend/routes/message_handling.py`:
    *   Updated for new template handling

### Frontend Changes
*   `front-end/src/components/Configuration.js`:
    *   Removed `ICMP API Key` input
    *   Updated auth flow

## 4. Next Steps

### Immediate Tasks
*   **Database Schema:**
    *   Verify template ID foreign key columns
    *   Ensure proper indexing
*   **Testing:**
    *   Update frontend tests
    *   Add backend tests for new auth and template logic
*   **Security:**
    *   Implement secure cookie settings
    *   Add rate limiting

### Future Enhancements
*   **User Authentication:**
    *   Implement proper login system
    *   Add session management
*   **Authorization:**
    *   Add role-based access control
    *   Implement resource-level permissions
*   **Template System:**
    *   Add template versioning
    *   Implement template validation
*   **UI Improvements:**
    *   Enhance template editor
    *   Add template preview
    *   Implement template search

## Related Documentation
- See [Implementation Guide](implementation_guide.md) for system architecture
- See [API Documentation](api_documentation.md) for endpoint details
- See [Development Roadmap](development_roadmap.md) for project timeline

Last Updated: 2025-05-12
