<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Calls Monitor</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --error-color: #e74c3c;
            --warning-color: #f39c12;
            --text-color: #333;
            --light-bg: #f5f5f5;
            --border-color: #ddd;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1, h2, h3 {
            margin-top: 0;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            background-color: var(--light-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .process-step {
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .step-header {
            background-color: var(--light-bg);
            padding: 10px 15px;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
        }
        
        .step-content {
            padding: 15px;
        }
        
        .prompt-box, .response-box {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .system-prompt {
            background-color: #e6f7ff;
            border: 1px solid #b3e0ff;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
        
        .template-info {
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #666;
        }
        
        .log-list {
            list-style-type: none;
            padding: 0;
        }
        
        .log-item {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .log-item:hover {
            background-color: #f0f8ff;
        }
        
        .text-muted {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .no-logs {
            color: #6c757d;
            font-style: italic;
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 30px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            overflow-x: auto;
        }
        
        .stage-node {
            padding: 15px;
            background-color: white;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            text-align: center;
            min-width: 150px;
            position: relative;
        }
        
        .stage-node.active {
            background-color: #e6f7ff;
            border-color: #0056b3;
            box-shadow: 0 0 10px rgba(0,123,255,0.3);
        }
        
        .stage-node.completed {
            background-color: #d4edda;
            border-color: #28a745;
        }
        
        .arrow {
            font-size: 24px;
            color: #6c757d;
            margin: 0 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background-color: white;
            border-color: var(--border-color);
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .json-viewer {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .api-inspector {
            margin-top: 30px;
        }
        
        .request-details, .response-details {
            margin-bottom: 20px;
        }
        
        pre {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>LLM Calls Monitor</h1>
            <p>View and analyze LLM calls and responses in real-time</p>
        </div>
    </header>
    
    <div class="container">
        <!-- Configuration Section -->
        <div class="card">
            <div class="card-header">
                <h2>Configuration</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="businessId">Business ID</label>
                    <input id="businessId" type="text" placeholder="Enter your Business ID">
                </div>
                
                <div class="form-group">
                    <label for="apiBaseUrl">API Base URL</label>
                    <input id="apiBaseUrl" type="text" placeholder="Enter API Base URL (e.g., /api or http://localhost:5000/api)" value="">
                    <small class="text-muted">Leave empty to use relative paths</small>
                    <div id="fileProtocolWarning" class="alert alert-warning" style="display: none;">
                        <strong>Note:</strong> You're opening this page directly from your file system. 
                        For proper functionality, please either:
                        <ol>
                            <li>Serve this page from a web server (recommended)</li>
                            <li>Or ensure your API server is running at the URL specified above</li>
                        </ol>
                        <div class="button-group">
                            <button onclick="startLocalServer()">Start Local Server</button>
                            <button onclick="window.open('http://localhost:8000/llm_calls.html', '_blank')">Open in Browser</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="apiKey">Business API Key</label>
                    <input id="apiKey" type="password" placeholder="Enter your Business API Key">
                </div>

                <div class="form-group">
                    <label for="ownerId">Owner ID</label>
                    <input id="ownerId" type="text" placeholder="Enter your Owner ID">
                    <small class="text-muted">This is your owner ID for authentication</small>
                </div>
                
                <div class="button-group">
                    <button id="loginButton" onclick="login()">Login</button>
                    <button id="logoutButton" onclick="logout()" class="hidden">Logout</button>
                </div>
                
                <div id="loginStatus" class="alert alert-info hidden">
                    Not logged in
                </div>
            </div>
        </div>
        
        <!-- Message Section -->
        <div class="card">
            <div class="card-header">
                <h2>Send Message</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="userId">Message Sender ID</label>
                    <input id="userId" type="text" placeholder="Enter User ID or generate new">
                    <button onclick="document.getElementById('userId').value = generateUUID()">Generate New</button>
                </div>
                
                <div class="form-group">
                    <label for="messageContent">Message Content</label>
                    <textarea id="messageContent" placeholder="Enter your message" rows="4"></textarea>
                </div>
                
                <div class="button-group">
                    <button id="sendButton" onclick="sendMessageAndDebug()">Send & Debug</button>
                </div>
                
                <div id="responseArea">
                    <div class="text-muted">Send a message to see the response</div>
                </div>
            </div>
        </div>
        
        <!-- Flow Diagram Section -->
        <div class="card">
            <div class="card-header">
                <h2>Message Processing Flow</h2>
            </div>
            <div class="card-body">
                <div class="flow-diagram">
                    <div class="stage-node" id="stage-selection-node">Stage Selection</div>
                    <div class="arrow">→</div>
                    <div class="stage-node" id="data-extraction-node">Data Extraction</div>
                    <div class="arrow">→</div>
                    <div class="stage-node" id="response-generation-node">Response Generation</div>
                </div>
            </div>
        </div>
        
        <!-- Processing Details Section -->
        <div class="card">
            <div class="card-header">
                <h2>Processing Details</h2>
            </div>
            <div class="card-body">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('processLogTab')">Process Log</div>
                    <div class="tab" onclick="switchTab('rawJsonTab')">Raw JSON</div>
                </div>
                
                <div id="processLogTab" class="tab-content active">
                    <div id="processLogArea" class="process-log">
                        <div class="no-logs">No processing data available yet</div>
                    </div>
                </div>
                
                <div id="rawJsonTab" class="tab-content">
                    <div id="rawJsonArea" class="json-viewer">
                        No JSON data available
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Logs Section -->
        <div class="card">
            <div class="card-header">
                <h2>Recent Process Logs</h2>
            </div>
            <div class="card-body">
                <div class="button-group">
                    <button onclick="fetchRecentLogs()">Refresh Logs</button>
                </div>
                <div id="recentLogsArea">
                    <div class="no-logs">No recent logs available</div>
                </div>
            </div>
        </div>
        
        <!-- Status Section -->
        <div class="card">
            <div class="card-header">
                <h2>Status</h2>
            </div>
            <div class="card-body">
                <div id="statusArea">
                    <div id="networkStatus" class="text-muted">No network activity yet</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let isLoggedIn = false;
        let currentLogId = null;
        let API_BASE_URL = window.location.origin + '/api';
        
        // Helper functions
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // Check if API server is running
        async function checkApiServer(url) {
            try {
                // Try the root endpoint first
                console.log('Checking API server at:', url);
                let response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    mode: 'cors'
                });
                
                // If that fails, try with no-cors mode as a last resort
                if (!response.ok) {
                    console.log('Standard endpoint failed, trying with no-cors mode...');
                    response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        },
                        mode: 'no-cors'
                    });
                    
                    // With no-cors, we can't check response.ok, so we assume it worked
                    // if we didn't get an error
                    return true;
                }
                
                return response.ok;
            } catch (error) {
                console.error('API server check failed:', error);
                return false;
            }
        }
        
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString();
        }
        
        function formatStepName(step) {
            const stepNames = {
                'stage_selection': 'Stage Selection',
                'data_extraction': 'Data Extraction',
                'response_generation': 'Response Generation'
            };
            return stepNames[step] || step;
        }
        
        function truncateText(text, maxLength) {
            if (!text) return 'N/A';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        function showSuccess(message) {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="alert alert-success">${message}</div>`;
        }
        
        function showError(message) {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="alert alert-error">${message}</div>`;
        }
        
        function updateStatus(message) {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="alert alert-info">${message}</div>`;
        }
        
        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Deactivate all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activate the selected tab and content
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
        }
        
        // Login/Logout functions
        async function login() {
            const businessId = document.getElementById('businessId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            const ownerId = document.getElementById('ownerId').value.trim();
            
            if (!businessId || !apiKey || !ownerId) {
                showError('Business ID, API Key, and Owner ID are required');
                return;
            }
            
            // Update API_BASE_URL if provided
            if (apiBaseUrl) {
                API_BASE_URL = apiBaseUrl;
            }
            
            updateStatus('Checking API server...');
            
            // Check if API server is running
            const isServerRunning = await checkApiServer(API_BASE_URL);
            if (!isServerRunning) {
                showError(`
                    <strong>API server is not running or not accessible!</strong><br><br>
                    Please ensure your API server is running at: ${API_BASE_URL}<br><br>
                    <strong>Troubleshooting tips:</strong>
                    <ul>
                        <li>Start your API server if it's not running</li>
                        <li>Check if the API URL is correct</li>
                        <li>If using localhost, make sure the server is running on the specified port</li>
                        <li>Check for any firewall or network issues</li>
                        <li><strong>CORS Issue:</strong> If you're opening this file directly from your file system, 
                            you may need to serve it from a web server or configure your API server to allow CORS</li>
                    </ul>
                    <br>
                    <strong>To serve this file from a web server:</strong>
                    <ol>
                        <li>Open a terminal/command prompt</li>
                        <li>Navigate to the directory containing this file</li>
                        <li>Run: <code>npx http-server -p 8000</code></li>
                        <li>Access the page at: <a href="http://localhost:8000/llm_calls.html" target="_blank">http://localhost:8000/llm_calls.html</a></li>
                    </ol>
                `);
                return;
            }
            
            updateStatus('Logging in...');
            
            try {
                // Make a request to the save-config endpoint to validate credentials
                const loginUrl = `${API_BASE_URL}/save-config`;
                console.log('Login URL:', loginUrl);
                
                const response = await fetch(loginUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        ownerId: ownerId,
                        businessId: businessId,
                        businessApiKey: apiKey
                    })
                });
                
                if (!response.ok) {
                    let errorText = '';
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || 'Unknown error';
                    } catch (jsonError) {
                        errorText = await response.text();
                    }
                    
                    throw new Error(`Login failed: ${errorText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Update login state
                    isLoggedIn = true;
                    
                    // Update UI
                    document.getElementById('loginButton').classList.add('hidden');
                    document.getElementById('logoutButton').classList.remove('hidden');
                    document.getElementById('loginStatus').classList.remove('hidden');
                    document.getElementById('loginStatus').innerHTML = `Logged in as Business ID: ${businessId}`;
                    document.getElementById('loginStatus').className = 'alert alert-success';
                    
                    // Enable message sending
                    document.getElementById('sendButton').disabled = false;
                    
                    // Fetch recent logs
                    fetchRecentLogs();
                    
                    showSuccess('Login successful!');
                } else {
                    throw new Error(data.error || 'Unknown error during login');
                }
            } catch (error) {
                console.error('Login error:', error);
                
                // Enhanced error reporting
                let errorMessage = `Login failed: ${error.message}`;
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage += `
                        <br><br>
                        <strong>Troubleshooting tips:</strong>
                        <ul>
                            <li>Check if the API server is running</li>
                            <li>Verify the API endpoint URL is correct</li>
                            <li>Check for CORS issues (if accessing from a different domain)</li>
                            <li>Ensure your network connection is stable</li>
                        </ul>
                        <br>
                        <strong>Technical details:</strong>
                        <ul>
                            <li>API URL: ${API_BASE_URL}/save-config</li>
                            <li>Business ID: ${businessId}</li>
                            <li>Owner ID: ${ownerId}</li>
                        </ul>
                    `;
                }
                
                showError(errorMessage);
                isLoggedIn = false;
            }
        }
        
        function logout() {
            isLoggedIn = false;
            
            // Update UI
            document.getElementById('loginButton').classList.remove('hidden');
            document.getElementById('logoutButton').classList.add('hidden');
            document.getElementById('loginStatus').innerHTML = 'Not logged in';
            document.getElementById('loginStatus').className = 'alert alert-info';
            
            // Disable message sending
            document.getElementById('sendButton').disabled = true;
            
            // Clear logs
            document.getElementById('recentLogsArea').innerHTML = '<div class="no-logs">No recent logs available</div>';
            document.getElementById('processLogArea').innerHTML = '<div class="no-logs">No processing data available</div>';
        }
        
        // Message sending function
        async function sendMessageAndDebug() {
            if (!isLoggedIn) {
                showError('You must login first before sending messages');
                return;
            }
            
            const businessId = document.getElementById('businessId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const userId = document.getElementById('userId').value.trim();
            const content = document.getElementById('messageContent').value.trim();
            
            if (!businessId || !apiKey || !userId || !content) {
                showError('Business ID, API Key, User ID, and Message Content are required');
                return;
            }
            
            updateStatus('Sending message...');
            
            try {
                const messageUrl = `${API_BASE_URL}/message`;
                console.log('Sending message to:', messageUrl);
                console.log('Request payload:', {
                    business_id: businessId,
                    user_id: userId,
                    message: content
                });
                
                const response = await fetch(messageUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'businessapikey': apiKey
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        business_id: businessId,
                        user_id: userId,
                        message: content
                    })
                });
                
                if (!response.ok) {
                    let errorText = '';
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || 'Unknown error';
                    } catch (jsonError) {
                        errorText = await response.text();
                    }
                    
                    throw new Error(`Failed to send message! status: ${response.status}, message: ${errorText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Message sent successfully!');
                    
                    // Display the response
                    const responseArea = document.getElementById('responseArea');
                    if (data.chat_window) {
                        const { user_message, ai_response } = data.chat_window;
                        responseArea.innerHTML = `
                            <div class="process-step">
                                <div class="step-header">User Message:</div>
                                <div class="prompt-box">${user_message.content}</div>
                            </div>
                            <div class="process-step">
                                <div class="step-header">AI Response:</div>
                                <div class="response-box">${ai_response.content}</div>
                            </div>
                        `;
                    } else {
                        responseArea.innerHTML = `
                            <div class="response-box">${data.response}</div>
                        `;
                    }
                    
                    // If there's a process log ID, fetch and display the details
                    if (data.process_log_id) {
                        currentLogId = data.process_log_id;
                        setTimeout(() => fetchProcessLog(data.process_log_id), 500);
                    } else {
                        showError('No process log ID returned. Detailed debugging not available.');
                    }
                    
                    // Refresh the recent logs
                    setTimeout(fetchRecentLogs, 1000);
                } else {
                    showError(data.error || 'Unknown error sending message');
                }
                
            } catch (error) {
                console.error('Message error:', error);
                
                // Enhanced error reporting
                let errorMessage = `Failed to send message: ${error.message}`;
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage += `
                        <br><br>
                        <strong>Troubleshooting tips:</strong>
                        <ul>
                            <li>Check if the API server is running</li>
                            <li>Verify the API endpoint URL is correct</li>
                            <li>Check for CORS issues (if accessing from a different domain)</li>
                            <li>Ensure your network connection is stable</li>
                        </ul>
                        <br>
                        <strong>Technical details:</strong>
                        <ul>
                            <li>API URL: ${API_BASE_URL}/message</li>
                            <li>Business ID: ${businessId}</li>
                            <li>User ID: ${userId}</li>
                        </ul>
                    `;
                }
                
                showError(errorMessage);
            }
        }
        
        // Fetch process log details
        async function fetchProcessLog(logId) {
            if (!isLoggedIn) {
                showError('You must login first before fetching logs');
                return;
            }
            
            const businessId = document.getElementById('businessId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!businessId || !apiKey || !logId) {
                showError('Business ID, API Key, and Log ID are required to fetch processing details');
                return;
            }
            
            updateStatus('Fetching process log...');
            
            try {
                const url = `${API_BASE_URL}/message/logs/${logId}?business_id=${encodeURIComponent(businessId)}`;
                console.log('Fetching process log from URL:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'businessapikey': apiKey
                    },
                    credentials: 'include',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    let errorText = '';
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || 'Unknown error';
                    } catch (jsonError) {
                        errorText = await response.text();
                    }
                    
                    throw new Error(`Failed to fetch process log! status: ${response.status}, message: ${errorText}`);
                }
                
                const logData = await response.json();
                
                // Display the process log
                displayProcessLog(logData);
                
                // Update flow diagram based on processing steps
                updateFlowDiagram(logData);
                
                // Display raw JSON
                document.getElementById('rawJsonArea').textContent = JSON.stringify(logData, null, 2);
                
                showSuccess('Process log fetched successfully!');
                
            } catch (error) {
                console.error('Error fetching process log:', error);
                
                // Enhanced error reporting
                let errorMessage = `Failed to fetch process log: ${error.message}`;
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage += `
                        <br><br>
                        <strong>Troubleshooting tips:</strong>
                        <ul>
                            <li>Check if the API server is running</li>
                            <li>Verify the API endpoint URL is correct</li>
                            <li>Check for CORS issues (if accessing from a different domain)</li>
                            <li>Ensure your network connection is stable</li>
                        </ul>
                        <br>
                        <strong>Technical details:</strong>
                        <ul>
                            <li>API URL: ${API_BASE_URL}/message/logs/${logId}</li>
                            <li>Business ID: ${businessId}</li>
                            <li>Log ID: ${logId}</li>
                        </ul>
                    `;
                }
                
                showError(errorMessage);
            }
        }
        
        // Fetch recent process logs
        async function fetchRecentLogs() {
            if (!isLoggedIn) {
                showError('You must login first before fetching logs');
                return;
            }
            
            const businessId = document.getElementById('businessId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!businessId || !apiKey) {
                showError('Business ID and API Key are required to fetch recent logs');
                return;
            }
            
            updateStatus('Fetching recent logs...');
            
            try {
                const url = `${API_BASE_URL}/message/logs/recent?business_id=${encodeURIComponent(businessId)}&limit=10`;
                console.log('Fetching recent logs from URL:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'businessapikey': apiKey
                    },
                    credentials: 'include',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    let errorText = '';
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || 'Unknown error';
                    } catch (jsonError) {
                        errorText = await response.text();
                    }
                    
                    throw new Error(`Failed to fetch recent logs! status: ${response.status}, message: ${errorText}`);
                }
                
                const logs = await response.json();
                
                // Display the recent logs
                displayRecentLogs(logs);
                
                showSuccess('Recent logs fetched successfully!');
                
            } catch (error) {
                console.error('Error fetching recent logs:', error);
                
                // Enhanced error reporting
                let errorMessage = `Failed to fetch recent logs: ${error.message}`;
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage += `
                        <br><br>
                        <strong>Troubleshooting tips:</strong>
                        <ul>
                            <li>Check if the API server is running</li>
                            <li>Verify the API endpoint URL is correct</li>
                            <li>Check for CORS issues (if accessing from a different domain)</li>
                            <li>Ensure your network connection is stable</li>
                        </ul>
                        <br>
                        <strong>Technical details:</strong>
                        <ul>
                            <li>API URL: ${API_BASE_URL}/message/logs/recent</li>
                            <li>Business ID: ${businessId}</li>
                        </ul>
                    `;
                }
                
                showError(errorMessage);
            }
        }
        
        // Display process log details
        function displayProcessLog(log) {
            const processLogArea = document.getElementById('processLogArea');
            
            if (!log) {
                processLogArea.innerHTML = '<div class="no-logs">No processing data available</div>';
                return;
            }
            
            let html = `
                <h3>Process Log Details</h3>
                <div class="process-step">
                    <div class="step-header">Original Message</div>
                    <div class="prompt-box">${log.original_message || 'N/A'}</div>
                    <div class="text-muted">
                        Log ID: ${log.log_id || 'N/A'}<br>
                        Conversation ID: ${log.conversation_id || 'N/A'}<br>
                        Time: ${formatDateTime(log.start_time) || 'N/A'}
                    </div>
                </div>
                
                <div class="process-step">
                    <div class="step-header">Current Stage Information</div>
                    <div class="step-content">
                        <div><strong>Stage ID:</strong> ${log.stage_id || 'No specific stage'}</div>
                        <div><strong>Stage Name:</strong> ${log.current_stage_name || 'Default'}</div>
                        ${log.agent_id ? `<div><strong>Agent ID:</strong> ${log.agent_id}</div>` : ''}
                    </div>
                </div>
            `;
            
            // Process each step
            if (log.processing_steps && log.processing_steps.length > 0) {
                html += `<h3>Processing Steps</h3>`;
                
                log.processing_steps.forEach((step, index) => {
                    html += `
                        <div class="process-step">
                            <div class="step-header">${formatStepName(step.step)} (Step ${index + 1})</div>
                            
                            <div class="step-content">
                                <div class="template-info">
                                    <strong>Template:</strong> ${step.template_name || 'Unknown Template'} (${step.template_id || 'N/A'})<br>
                                    <strong>Time:</strong> ${formatDateTime(step.timestamp) || 'N/A'}
                                </div>
                                
                                ${step.system_prompt ? `
                                <div class="system-prompt-container">
                                    <strong>System Prompt:</strong>
                                    <div class="system-prompt">${step.system_prompt}</div>
                                </div>
                                ` : ''}
                                
                                <div class="prompt-container">
                                    <strong>Prompt:</strong>
                                    <div class="prompt-box" style="white-space: pre-wrap;">${step.prompt || 'N/A'}</div>
                                </div>
                                
                                <div class="response-container">
                                    <strong>Response:</strong>
                                    <div class="response-box" style="white-space: pre-wrap;">${step.response || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<div class="no-logs">No processing steps recorded</div>';
            }
            
            // Final response
            html += `
                <h3>Final Result</h3>
                <div class="process-step">
                    <div class="step-header">Final Response</div>
                    <div class="response-box" style="white-space: pre-wrap;">${log.final_response || 'N/A'}</div>
                </div>
            `;
            
            processLogArea.innerHTML = html;
        }
        
        // Display recent logs list
        function displayRecentLogs(logs) {
            const recentLogsArea = document.getElementById('recentLogsArea');
            
            if (!logs || logs.length === 0) {
                recentLogsArea.innerHTML = '<div class="no-logs">No recent logs available</div>';
                return;
            }
            
            let html = '<ul class="log-list">';
            
            logs.forEach(log => {
                html += `
                    <li class="log-item" onclick="fetchProcessLog('${log.log_id}')">
                        <strong>Message:</strong> ${truncateText(log.original_message, 50)}<br>
                        <strong>Time:</strong> ${formatDateTime(log.start_time)}<br>
                        <span class="text-muted">Log ID: ${log.log_id}</span>
                    </li>
                `;
            });
            
            html += '</ul>';
            
            recentLogsArea.innerHTML = html;
        }
        
        // Reset flow diagram
        function resetFlowDiagram() {
            const nodes = document.querySelectorAll('.stage-node');
            nodes.forEach(node => {
                node.classList.remove('active', 'completed');
            });
        }
        
        // Update flow diagram based on processing steps
        function updateFlowDiagram(log) {
            if (!log || !log.processing_steps || log.processing_steps.length === 0) {
                return;
            }
            
            // Reset the diagram
            resetFlowDiagram();
            
            // Mark completed steps
            const completedSteps = new Set();
            log.processing_steps.forEach(step => {
                completedSteps.add(step.step);
            });
            
            // Update nodes based on completed steps
            if (completedSteps.has('stage_selection')) {
                document.getElementById('stage-selection-node').classList.add('completed');
            }
            
            if (completedSteps.has('data_extraction')) {
                document.getElementById('data-extraction-node').classList.add('completed');
            }
            
            if (completedSteps.has('response_generation')) {
                document.getElementById('response-generation-node').classList.add('completed');
            }
            
            // Mark the current active step (last step in the list)
            const lastStep = log.processing_steps[log.processing_steps.length - 1];
            const activeNodeId = `${lastStep.step}-node`;
            document.getElementById(activeNodeId).classList.add('active');
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Disable send button until login
            document.getElementById('sendButton').disabled = true;
            
            // Set default API URL to localhost if opened from file://
            let defaultApiUrl;
            if (window.location.protocol === 'file:') {
                defaultApiUrl = 'http://localhost:5000/api';
                console.log('Detected file:// protocol, using default API URL:', defaultApiUrl);
                // Show warning about file:// protocol
                document.getElementById('fileProtocolWarning').style.display = 'block';
                
                // Add a button to open the page in a web server
                const buttonGroup = document.createElement('div');
                buttonGroup.className = 'button-group';
                buttonGroup.innerHTML = `
                    <button onclick="startLocalServer()">Start Local Server</button>
                    <button onclick="window.open('http://localhost:8000/llm_calls.html', '_blank')">Open in Browser</button>
                `;
                document.getElementById('fileProtocolWarning').appendChild(buttonGroup);
            } else {
                defaultApiUrl = window.location.origin + '/api';
                console.log('Using origin-based API URL:', defaultApiUrl);
            }
            
            document.getElementById('apiBaseUrl').value = defaultApiUrl;
            API_BASE_URL = defaultApiUrl;
            
            // Update API_BASE_URL when the input changes
            document.getElementById('apiBaseUrl').addEventListener('change', function() {
                API_BASE_URL = this.value.trim();
                console.log('API Base URL updated to:', API_BASE_URL);
            });
            
            // Add a note about the API URL
            const apiUrlNote = document.createElement('small');
            apiUrlNote.className = 'text-muted';
            apiUrlNote.innerHTML = 'Enter the full API URL (e.g., http://localhost:5000/api)';
            document.getElementById('apiBaseUrl').parentNode.appendChild(apiUrlNote);
        });
        
        // Function to start a local server
        function startLocalServer() {
            const instructions = `
                <strong>To start a local server:</strong>
                <ol>
                    <li>Open a terminal/command prompt</li>
                    <li>Navigate to the directory containing this file</li>
                    <li>Run one of these commands:</li>
                    <ul>
                        <li><code>python -m http.server 8000</code> (Python 3)</li>
                        <li><code>python -m SimpleHTTPServer 8000</code> (Python 2)</li>
                        <li><code>npx http-server -p 8000</code> (Node.js)</li>
                    </ul>
                    <li>Then open <a href="http://localhost:8000/llm_calls.html" target="_blank">http://localhost:8000/llm_calls.html</a> in your browser</li>
                </ol>
                <p><strong>Note:</strong> You need to keep the terminal window open while using the application.</p>
            `;
            
            showInfo(instructions);
        }
        
        function showInfo(message) {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="alert alert-info">${message}</div>`;
        }
    </script>
</body>
</html> 